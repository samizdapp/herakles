version: "2"
volumes:
  app_manifests:
  service_upnp:
  service_hostname:
  proxy_nm:
  service_yggdrasil:
  shared_yggdrasil:
  service_yggdrasil_sock:
  shared_etc:
  postgres2:
  gateway_client:
  pleroma_uploads:
  ipfs:
  monitor:
services:
  daemon_caddy:
    build: ./caddy
    restart: always
    network_mode: host
    volumes:
      - shared_yggdrasil:/yggdrasil
      - service_yggdrasil:/etc/yggdrasil-network
      - gateway_client:/next
    depends_on:
      - yggdrasil
  gateway_client:
    build:
      context: ./athena
      dockerfile: ./packages/gateway-client/Dockerfile
      args:
        - VERSION=latest
    network_mode: host
    restart: always
    volumes:
      - service_upnp:/usr/src/volumes/service_upnp
      - service_hostname:/usr/src/volumes/service_hostname
      - gateway_client:/usr/src/volumes/gateway_client
    depends_on:
      - daemon_caddy
  status_service:
    build:
      context: ./athena
      dockerfile: ./packages/status-service/Dockerfile
      args:
        - VERSION=latest
    network_mode: host
    restart: always
  app_service:
    build:
      context: ./athena
      dockerfile: ./packages/app-service/Dockerfile
      args:
        - VERSION=latest
    volumes:
      - app_manifests:/usr/src/volumes/app_manifests
    network_mode: host
    restart: always
    labels:
      io.balena.features.balena-socket: "1"
  daemon_pleroma:
    restart: always
    network_mode: host
    build:
      context: ./pleroma
    volumes:
      - shared_etc:/shared_etc
      - service_yggdrasil:/etc/yggdrasil-network
      - pleroma_uploads:/var/lib/pleroma/uploads
    environment:
      DOMAIN: exmaple.com
      INSTANCE_NAME: Pleroma
      ADMIN_EMAIL: admin@example.com
      NOTIFY_EMAIL: notify@example.com
      DB_USER: pleroma
      DB_PASS: ChangeMe!
      DB_NAME: pleroma
      DB_HOST: localhost
    depends_on:
      - postgres
      - yggdrasil
  postgres:
    image: postgres:12.1-alpine
    restart: always
    network_mode: host
    environment:
      POSTGRES_USER: pleroma
      POSTGRES_PASSWORD: ChangeMe!
      POSTGRES_DB: pleroma
    volumes:
      - postgres2:/var/lib/postgresql/data
  service_wifi-connect:
    build: ./service/wifi-connect
    privileged: true
    network_mode: "host"
    labels:
      io.balena.features.dbus: "1"
    cap_add:
      - NET_ADMIN
    environment:
      DBUS_SYSTEM_BUS_ADDRESS: "unix:path=/host/run/dbus/system_bus_socket"
      PORTAL_SSID: "SamizdApp"
      PORTAL_PASSPHRASE: "samizdapp"
    depends_on:
      - gateway_client
      - postgres
      - daemon_pleroma
      - daemon_proxy
      - daemon_caddy
      - mdns-advertise
      - yggdrasil
      - yggdrasil_crawler
      - yggdrasil_upnp
      - yggdrasil_watcher

  daemon_proxy:
    build: ./lib
    labels:
      io.balena.features.dbus: "1"
    privileged: true
    network_mode: host
    restart: always
    volumes:
      - service_upnp:/proxy/upnp
      - shared_etc:/shared_etc
      - shared_yggdrasil:/yggdrasil
      - gateway_client:/next
    depends_on:
      - gateway_client
      - yggdrasil
    environment:
      PUBLIC_PATH: "/next/assets"
      ID_PATH: "/shared_etc/libp2p.id"
  # These will eventually live in an inherited project, but until they have a home they are saved here
  yggdrasil:
    # https://stackoverflow.com/a/37090165
    build:
      context: ./yggdrasil/
    privileged: true
    restart: "always"
    network_mode: host
    # expose:
    #   - "9001"
    volumes:
      - service_yggdrasil:/etc/yggdrasil-network
      - service_yggdrasil_sock:/var/run/
      - shared_etc:/shared_etc
      - shared_yggdrasil:/yggdrasil
    depends_on:
      - status_service
  yggdrasil_upnp:
    # https://stackoverflow.com/a/37090165
    build:
      context: ./yggdrasil/
      dockerfile: Dockerfile.upnp
    privileged: true
    restart: "no"
    network_mode: host
    # expose:
    #   - "9001"
    volumes:
      - service_yggdrasil:/etc/yggdrasil-network
      - service_yggdrasil_sock:/var/run/
      - shared_etc:/shared_etc
      - shared_yggdrasil:/yggdrasil
  yggdrasil_watcher:
    # https://stackoverflow.com/a/37090165
    build:
      context: ./yggdrasil/
      dockerfile: Dockerfile.watcher
    privileged: true
    network_mode: host
    # expose:
    #   - "9001"
    volumes:
      - service_yggdrasil:/etc/yggdrasil-network
      - service_yggdrasil_sock:/var/run/
      - shared_etc:/shared_etc
      - shared_yggdrasil:/yggdrasil
    depends_on:
      - yggdrasil
  yggdrasil_crawler:
    # https://stackoverflow.com/a/37090165
    build:
      context: ./yggdrasil/
      dockerfile: Dockerfile.crawler
    privileged: true
    restart: "always"
    network_mode: host
    # expose:
    #   - "9001"
    volumes:
      - service_yggdrasil:/etc/yggdrasil-network
      - service_yggdrasil_sock:/var/run/
      - shared_etc:/shared_etc
      - shared_yggdrasil:/yggdrasil
    depends_on:
      - yggdrasil
  mdns-advertise:
    build: ./mdns-advertise
    restart: "always"
    privileged: true
    network_mode: host
    labels:
      io.balena.features.dbus: "1"
    environment:
      DBUS_SYSTEM_BUS_ADDRESS: "unix:path=/host/run/dbus/system_bus_socket"
      MDNS_TLD: "samizdev.local"
  monitor:
    build: ./monitor
    restart: "always"
    labels:
      io.balena.features.supervisor-api: "1"
      io.balena.features.journal-logs: "1"
    volumes:
      - monitor:/monitor
  hostname:
    build: ./service/hostname
    restart: no
    labels:
      io.balena.features.supervisor-api: 1
    environment:
      SET_HOSTNAME: samizdapp
